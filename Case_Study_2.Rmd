---
title: "Case Study 2"
author: "Michael Daniel Bigler and Liam Arthur Phan"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    code_folding: hide
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	fig.align = "center")
rm(list = ls())
cat("\014")

```

<break>

> Goal:

# Packages

> In the following all the packages needed for this case study are loaded.

```{r packages}

library(ggplot2)
library(DT)
library(jtools)
library(kableExtra)
library(pastecs)
library(rcompanion)   #Histogram and Normal Curve
library(nortest) #Kolmogorov-Smirnov-Test
library(corrplot) #correlation matrix plot
library(olsrr)  #VIF and Tolerance Values
library(dplyr)
library(pastecs)
library(REdaS) #Bartelett's Test
library(psych)
library(lm.beta)
library(RColorBrewer)

```

# Data

> . The source is thereby listed below.

> Source: **Advanced Data Driven Decision Making** [S401024](https://moodle.unige.ch/course/view.php?id=2675 "2675") - University of Geneva (GSEM)
>
> Marcel Paulssen, Professor\
> Fereshteh Vahidi, Teaching Assistant\
> Anastasia Floru, Teaching Assistant

```{r data loading}
Mydata <- read.csv("DATA/Data File_Case_Study_Factor Analysis_MD.csv", header=TRUE)

# selecting questions
Mydata_with_y <- Mydata[,c(9:41, 43:45, 51:52)]
Mydata_with_y <- na.omit(Mydata_with_y)
Mydata_qd <- Mydata[,9:41]
rm(Mydata)
```

## Data Analysis

```{r}
list_na =colnames(Mydata_with_y)[apply(Mydata_with_y,2,anyNA)]
list_na
```

There are missing values -\> replace by mean or delete rows

```{r}
stat.desc(Mydata_with_y, norm=TRUE)
```

```{r}
lillie.test(Mydata_with_y$wtp1)
lillie.test(Mydata_with_y$wtp2)
lillie.test(Mydata_with_y$wtp3)
lillie.test(Mydata_with_y$ri1)
lillie.test(Mydata_with_y$ri2)
```

```{r}

cor_mat <- cor(Mydata_with_y)
corrplot(as.matrix(cor_mat), type="upper", order="hclust", tl.col="black", tl.srt=45,tl.cex = 0.5)

```

```{r}
model <- lm(wtp1 + wtp2 + wtp3 + ri1 + ri2 ~., data = Mydata_with_y)
ols_vif_tol(model)
```

```{r}
par(mfrow = c(2, 2)) # Return plotting panel to 1 section
plot(model)
```

# Orthogonal Factor Analysis

## Principal axes factoring with varimax
```{r}
fa_result <- fa(Mydata_qd, nfactors = 9, rotate = "varimax", fm = "pa")
fa_result$loadings
```


```{r}
cor_mat <- cor(Mydata_with_y)
corrplot(as.matrix(cor_mat))
```

## Anti-image correlation, KMO and Bartlett's test

```{r}
KMOTEST=KMOS(Mydata_qd)
KMOTEST
```

```{r}
bart_spher(Mydata_qd, use="complete.obs")
```

check if this is the right use to take --\> dont bother we need to do list wise deletion (rows) or replace by mean

```{r}
sort(KMOTEST$MSA)
```

```{r}
KMOTEST=KMOS(Mydata_qd)
KMOTEST$KMO
```

## Principal component analysis 1

```{r}
PC0 <- psych::principal(Mydata_qd, rotate="varimax", scores=TRUE)

plot(PC0$values,xlab="Factor Number",ylab="Eigenvalue",main="Scree plot",cex.lab=1.2,cex.axis=1.2,cex.main=1.8)+abline(h=1)

```

```{r}
PC1 <- psych::principal(Mydata_qd, 
                        rotate="varimax",
                        nfactors=9, 
                        scores=TRUE)

PC1_communalities=data.frame(sort(PC1$communality))
PC1_communalities
```

## Total variance explained

```{r}
EigenValue=PC1$values
Variance=EigenValue/ncol(Mydata_qd)*100
SumVariance=cumsum(EigenValue/ncol(Mydata_qd))

Total_Variance_Explained=cbind(EigenValue=EigenValue[EigenValue>0],Variance=Variance[Variance>0],Total_Variance=SumVariance[Variance>0])
Total_Variance_Explained
```

## Principal component analysis 2

```{r}
print(PC1$loadings, cutoff=0.3,sort=TRUE)
```

```{r}
XXX = c(x1:x4,x6:x26,x28:x30) # CHANGE THIS
PC2 <- psych::principal(subset(Mydata_qd, select = XXX), rotate="varimax",nfactors=28, scores=TRUE)
PC2 <- psych::principal(subset(Mydata_qd, select = XXX), rotate="varimax", scores=TRUE)

plot(PC2$values,xlab="Factor Number",ylab="Eigenvalue",main="Scree plot",cex.lab=1.2,cex.axis=1.2,cex.main=1.8)+abline(h=1)
```

```{r}
data.frame(PC2$values)
```

```{r}
PC3 <- psych::principal(subset(Mydata_qd, select = XXX), rotate="varimax",nfactors=9, scores=TRUE)
print(PC3$loadings, cutoff=0.3,sort=TRUE)
```


## Interpret the factors based on the literature review on quality dimensions 

## Do all of the variables in your final solution show clear loading patterns?

## For your final solution run a principal component analysis and compare the results. Are there differences to your solution based on principal axis factoring?

## What do the eigenvalues of the factors/quality dimensions tell us about their relevance for repurchase behaviour?

# Oblique Factor Analysis

## : Run an oblique factor analysis with the variables of your final solution in exercise 1 using Promax

## How high are the factors correlated and what is the highest correlation between factors
